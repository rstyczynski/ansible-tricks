---
# Filesystem backend implementation for async_job_save
# This file contains the original filesystem-based persistence logic

- name: "Save Job (FS): Ensure state directory exists for host"
  ansible.builtin.file:
    path: "{{ async_job_save_state_dir }}/{{ async_job_save_host }}"
    state: directory
    mode: '0700'
  delegate_to: localhost

- name: "Save Job (FS): Ensure playbook directory exists"
  ansible.builtin.file:
    path: "{{ async_job_save_state_dir }}/{{ async_job_save_host }}/{{ async_job_save_playbook_name }}"
    state: directory
    mode: '0700'
  delegate_to: localhost

- name: "Save Job (FS): Write job state to file by name"
  ansible.builtin.copy:
    content: |
      {
        "job_name": "{{ async_job_save_job_name }}",
        "host": "{{ async_job_save_host }}",
        "ansible_job_id": "{{ async_job_save_ansible_job_id }}",
        "save_time": "{{ ansible_date_time.iso8601 }}",
        "metadata": {{ async_job_save_metadata | to_json }}
      }
    dest: "{{ async_job_save_state_dir }}/{{ async_job_save_host }}/{{ async_job_save_playbook_name }}/{{ async_job_save_job_name }}.json"
    mode: '0600'
  delegate_to: localhost

- name: "Save Job (FS): Set state file path"
  ansible.builtin.set_fact:
    async_job_save_state_file: "{{ async_job_save_state_dir }}/{{ async_job_save_host }}/{{ async_job_save_playbook_name }}/{{ async_job_save_job_name }}.json"
