---
# monitor_output.yml - Task file for monitoring async output
# This is included in a loop by the main playbook

- name: Check task status
  ansible.builtin.async_status:
    jid: "{{ async_result.ansible_job_id }}"
  register: job_status
  ignore_errors: true
  changed_when: false

- name: Read stdout file
  ansible.builtin.slurp:
    src: "{{ output_dir }}/{{ custom_job_id }}.stdout"
  register: stdout_content
  ignore_errors: true

- name: Read stderr file
  ansible.builtin.slurp:
    src: "{{ output_dir }}/{{ custom_job_id }}.stderr"
  register: stderr_content
  ignore_errors: true

- name: Display monitoring header
  ansible.builtin.debug:
    msg: |
      ─────────────────────────────────────────────────────────
      Monitoring Check {{ monitor_check_index | default(0) + 1 }} - Task {{ 'COMPLETED' if (job_status.finished | default(false)) else 'RUNNING' }}
      ─────────────────────────────────────────────────────────

- name: Display stdout output (full mode)
  ansible.builtin.debug:
    msg: "{{ (stdout_content.content | b64decode).split('\n') }}"
  when:
    - display_mode == 'full'
    - stdout_content is succeeded
    - stdout_content.content | length > 0

- name: Display stdout output (tail mode)
  ansible.builtin.debug:
    msg: "{{ ((stdout_content.content | b64decode).split('\n') | reject('equalto', '') | list)[-(tail_lines | int):] }}"
  when:
    - display_mode == 'tail'
    - stdout_content is succeeded
    - stdout_content.content | length > 0

- name: Display stderr output (full mode)
  ansible.builtin.debug:
    msg: "{{ (stderr_content.content | b64decode).split('\n') }}"
  when:
    - display_mode == 'full'
    - stderr_content is succeeded
    - stderr_content.content | length > 0

- name: Display stderr output (tail mode)
  ansible.builtin.debug:
    msg: "{{ ((stderr_content.content | b64decode).split('\n') | reject('equalto', '') | list)[-(tail_lines | int):] }}"
  when:
    - display_mode == 'tail'
    - stderr_content is succeeded
    - stderr_content.content | length > 0

- name: Pause before next check
  ansible.builtin.pause:
    seconds: "{{ monitor_interval }}"
  when: not (job_status.finished | default(false))
