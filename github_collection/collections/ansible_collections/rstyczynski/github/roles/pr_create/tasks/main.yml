# INPUT VARIABLES TABLE
# | name                      | type   | description                                 |
# |---------------------------|--------|---------------------------------------------|
# | pr_create_dest_path       | string | Destination path to the git repository      |
# | pr_create_base_branch     | string | Base branch for PR                          |
# | pr_create_pr_title        | string | PR title (optional)                          |
# | pr_create_pr_body         | string | PR body/description (optional)               |
#
# OUTPUT VARIABLES TABLE
# | name                          | type   | description                                    |
# |-------------------------------|--------|------------------------------------------------|
# | pr_create_current_branch      | dict   | Current branch name                            |
# | pr_create_remote_branch_check| dict   | Result of checking if branch is pushed         |
# | pr_create_existing_pr         | dict   | Existing PR number if found                    |
# | pr_create_final_pr_title      | string | Final PR title to use                          |
# | pr_create_final_pr_body       | string | Final PR body to use                           |
# | pr_create_pr_create_result    | dict   | Result of creating PR                           |
---
- name: "PR Create: Validate arguments"
  ansible.builtin.validate_argument_spec:
    argument_spec: "{{ (lookup('file', role_path + '/meta/argument_specs.yml') | from_yaml).argument_specs.main.options }}"

# Precheck already verified gh CLI availability
# gh CLI will provide its own error if not authenticated

- name: "PR Create: Get current branch name"  # noqa: command-instead-of-module

  ansible.builtin.command:
    cmd: git branch --show-current
    chdir: "{{ pr_create_dest_path }}"
  register: pr_create_current_branch
  changed_when: false

- name: "PR Create: Check if current branch is pushed to remote"  # noqa: command-instead-of-module

  ansible.builtin.command:
    cmd: git ls-remote --heads origin {{ pr_create_current_branch.stdout }}
    chdir: "{{ pr_create_dest_path }}"
  register: pr_create_remote_branch_check
  changed_when: false
  failed_when: false

- name: "PR Create: Fail if branch is not pushed to remote"

  ansible.builtin.fail:
    msg: "Branch {{ pr_create_current_branch.stdout }} is not pushed to remote. Push it first before creating a PR."
  when: pr_create_remote_branch_check.stdout == ""

- name: "PR Create: Check if pull request already exists"  # noqa: command-instead-of-module

  ansible.builtin.command:
    cmd: gh pr list --head {{ pr_create_current_branch.stdout }} --json number --jq '.[0].number'
    chdir: "{{ pr_create_dest_path }}"
  register: pr_create_existing_pr
  changed_when: false
  failed_when: false

- name: "PR Create: Set PR title"

  ansible.builtin.set_fact:
    pr_create_final_pr_title: >-
      {% if pr_create_pr_title is defined and pr_create_pr_title != "" %}
      {{ pr_create_pr_title }}
      {% else %}
      {{ pr_create_current_branch.stdout }}
      {% endif %}

- name: "PR Create: Set PR body"

  ansible.builtin.set_fact:
    pr_create_final_pr_body: >-
      {% if pr_create_pr_body is defined and pr_create_pr_body != "" %}
      {{ pr_create_pr_body }}
      {% else %}
      Pull request for {{ pr_create_current_branch.stdout }}
      {% endif %}

- name: "PR Create: Create pull request if it doesn't exist"  # noqa: command-instead-of-module

  ansible.builtin.command:
    cmd: >
      gh pr create
      --base {{ pr_create_base_branch }}
      --head {{ pr_create_current_branch.stdout }}
      --title "{{ pr_create_final_pr_title }}"
      --body "{{ pr_create_final_pr_body }}"
    chdir: "{{ pr_create_dest_path }}"
  when: pr_create_existing_pr.stdout == ""
  register: pr_create_pr_create_result
  changed_when: pr_create_pr_create_result.rc == 0

- name: "PR Create: Display PR information"

  ansible.builtin.debug:
    msg: "Pull request already exists: #{{ pr_create_existing_pr.stdout }}"
  when: pr_create_existing_pr.stdout != ""

- name: "PR Create: Display new PR information"

  ansible.builtin.debug:
    msg: "{{ pr_create_pr_create_result.stdout }}"
  when: pr_create_pr_create_result is not skipped and pr_create_pr_create_result.stdout is defined
