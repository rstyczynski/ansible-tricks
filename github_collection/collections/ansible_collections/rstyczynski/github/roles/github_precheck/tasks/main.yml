# INPUT VARIABLES TABLE
# | name  | type | description                                 |
# |-------|------|---------------------------------------------|
#
# OUTPUT VARIABLES TABLE
# | name                          | type   | description                                    |
# |-------------------------------|--------|------------------------------------------------|
# | github_precheck_git_version   | dict   | Git version information                        |
# | github_precheck_gh_version    | dict   | GitHub CLI version information                 |
# | github_precheck_gh_auth_status| dict   | GitHub CLI authentication status                |
---
- name: "Precheck: Ensure git is available"  # noqa: command-instead-of-module
  ansible.builtin.command: git --version
  register: github_precheck_git_version
  changed_when: false

- name: "Precheck: Display git version"
  ansible.builtin.debug:
    msg: "Using {{ github_precheck_git_version.stdout }}"

- name: "Precheck: Check if gh CLI is available"  # noqa: command-instead-of-module
  ansible.builtin.command: gh --version
  register: github_precheck_gh_version
  changed_when: false
  # failed_when removed - will fail if gh not found (hard check)

- name: "Precheck: Display gh CLI version"
  ansible.builtin.debug:
    msg: "Using {{ github_precheck_gh_version.stdout }}"

- name: "Precheck: Verify gh CLI is installed"
  ansible.builtin.assert:
    that:
      - github_precheck_gh_version.rc == 0
    fail_msg: |
      GitHub CLI (gh) is not installed or not in PATH.

      The rstyczynski.github collection requires gh CLI for GitHub operations.

      Install gh CLI: https://cli.github.com/

      Installation methods:
        - macOS: brew install gh
        - Linux: https://github.com/cli/cli/blob/trunk/docs/install_linux.md
        - Windows: choco install gh
    success_msg: "GitHub CLI (gh) is available: {{ github_precheck_gh_version.stdout }}"

- name: "Precheck: Check if gh CLI is authenticated"  # noqa: command-instead-of-module
  ansible.builtin.command: gh auth status
  register: github_precheck_gh_auth_status
  changed_when: false
  failed_when: false
  when: github_precheck_gh_version.rc == 0

- name: "Precheck: Display gh CLI auth status"
  ansible.builtin.debug:
    msg: "GitHub CLI is authenticated"
  when: github_precheck_gh_version.rc == 0 and github_precheck_gh_auth_status.rc == 0

- name: "Precheck: Info if gh CLI is not authenticated"
  ansible.builtin.debug:
    msg: "INFO: GitHub CLI is not authenticated. github_auth role will handle authentication."
  when: github_precheck_gh_version.rc == 0 and github_precheck_gh_auth_status.rc != 0
