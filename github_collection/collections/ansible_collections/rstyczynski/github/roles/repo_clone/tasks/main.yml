# INPUT VARIABLES TABLE
# | name                      | type   | description                                 |
# |---------------------------|--------|---------------------------------------------|
# | repo_clone_repo_url       | string | Repository URL to clone                     |
# | repo_clone_dest_path      | string | Destination path for the repository          |
# | repo_clone_base_branch    | string | Base branch name                             |
# | repo_clone_new_branch     | string | New branch name                              |
#
# OUTPUT VARIABLES TABLE
# | name                          | type   | description                                    |
# |-------------------------------|--------|------------------------------------------------|
# | repo_clone_repo_exists       | dict   | Result of checking if repository exists        |
# | repo_clone_git_result        | dict   | Result of git clone/update operation          |
# | repo_clone_current_branch     | dict   | Current active branch name                     |
# | repo_clone_remote_branch_check| dict   | Result of checking if branch is pushed         |
---
- name: "Clone: Validate arguments"
  ansible.builtin.validate_argument_spec:
    argument_spec: "{{ (lookup('file', role_path + '/meta/argument_specs.yml') | from_yaml).argument_specs.main.options }}"

- name: "Clone: Check if repository exists"
  ansible.builtin.stat:
    path: "{{ repo_clone_dest_path }}/.git"
  register: repo_clone_repo_exists

- name: "Clone: Clone repository if it doesn't exist"
  ansible.builtin.git:
    repo: "{{ repo_clone_repo_url }}"
    dest: "{{ repo_clone_dest_path }}"
    version: "{{ repo_clone_base_branch }}"
    clone: true
    update: false
  when: not repo_clone_repo_exists.stat.exists
  register: repo_clone_git_result

- name: "Clone: Get current active branch name"  # noqa: command-instead-of-module
  ansible.builtin.command:
    cmd: git branch --show-current
    chdir: "{{ repo_clone_dest_path }}"
  when: repo_clone_repo_exists.stat.exists
  register: repo_clone_current_branch
  changed_when: false
  failed_when: false

- name: "Clone: Display current branch name"
  ansible.builtin.debug:
    msg: "{{ repo_clone_current_branch.stdout }} vs {{ repo_clone_new_branch }}"
  when: repo_clone_repo_exists.stat.exists and repo_clone_current_branch.stdout is defined

- name: "Clone: Check if local branch is pushed to remote"  # noqa: command-instead-of-module
  ansible.builtin.command:
    cmd: git ls-remote --heads origin {{ repo_clone_current_branch.stdout }}
    chdir: "{{ repo_clone_dest_path }}"
  when: repo_clone_repo_exists.stat.exists
  register: repo_clone_remote_branch_check
  changed_when: false
  failed_when: false

- name: "Clone: Display remote branch check"
  ansible.builtin.debug:
    msg: "{{ repo_clone_remote_branch_check.stdout }}"
  when: repo_clone_repo_exists.stat.exists and repo_clone_remote_branch_check.stdout is defined

- name: "Clone: Update repository base_branch if it's active one"
  ansible.builtin.git:
    repo: "{{ repo_clone_repo_url }}"
    dest: "{{ repo_clone_dest_path }}"
    version: "{{ repo_clone_base_branch }}"
    update: true
  when:
    - repo_clone_repo_exists.stat.exists
    - (repo_clone_current_branch.stdout | default('')) != repo_clone_new_branch
    - (repo_clone_current_branch.stdout | default('')) == repo_clone_base_branch
  register: repo_clone_git_result

- name: "Clone: Update repository new_branch if it's the active one and pushed to remote"
  ansible.builtin.git:
    repo: "{{ repo_clone_repo_url }}"
    dest: "{{ repo_clone_dest_path }}"
    version: "{{ repo_clone_new_branch }}"
    update: true
  when:
    - repo_clone_repo_exists.stat.exists
    - (repo_clone_current_branch.stdout | default('')) == repo_clone_new_branch
    - repo_clone_remote_branch_check.stdout != ""
  register: repo_clone_git_result
