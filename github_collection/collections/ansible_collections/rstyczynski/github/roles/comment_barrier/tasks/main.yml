# INPUT VARIABLES TABLE
# | name                         | type  | description                                      |
# |------------------------------|-------|--------------------------------------------------|
# | comment_barrier_repo         | str   | Repository in owner/name format                  |
# | comment_barrier_issue_number | int   | Issue or PR number to monitor                    |
# | comment_barrier_patterns     | list  | List of regex patterns to search in comments     |
# | comment_barrier_timeout      | int   | Timeout in seconds                               |
# | comment_barrier_interval     | int   | Polling interval in seconds                      |
# | comment_barrier_latest_only  | bool  | Whether to check only the latest comment         |
#
# OUTPUT VARIABLES TABLE
# | name                         | type  | description                                      |
# | comment_barrier_matched      | bool  | Whether a matching comment was found             |
# | comment_barrier_matched_body | str   | Matched comment body                             |
# | comment_barrier_matched_author| str  | Author login of the matched comment              |
# | comment_barrier_matched_at   | str   | Timestamp of the matched comment                 |
---
- name: "Comment barrier: validate arguments"
  ansible.builtin.validate_argument_spec:
    argument_spec: "{{ (lookup('file', role_path + '/meta/argument_specs.yml') | from_yaml).argument_specs.main.options }}"

- name: "Comment barrier: ensure timeout and interval are positive"
  ansible.builtin.assert:
    that:
      - comment_barrier_timeout | int > 0
      - comment_barrier_interval | int > 0
    fail_msg: "comment_barrier_timeout and comment_barrier_interval must be greater than zero"

- name: "Comment barrier: compute retry attempts"
  ansible.builtin.set_fact:
    comment_barrier_attempts: >-
      {{ ((comment_barrier_timeout | int + (comment_barrier_interval | int) - 1) // (comment_barrier_interval | int)) | int }}

- name: "Comment barrier: poll for matching comment"  # noqa: command-instead-of-module
  ansible.builtin.command: >-
    gh api repos/{{ comment_barrier_repo }}/issues/{{ comment_barrier_issue_number }}/comments
  register: comment_barrier_poll
  changed_when: false
  failed_when: comment_barrier_poll.rc != 0
  retries: "{{ comment_barrier_attempts }}"
  delay: "{{ comment_barrier_interval }}"
  until: >-
    (
      (
        comment_barrier_latest_only
        | ternary(
            (comment_barrier_poll.stdout | default('[]') | from_json | list)[-1:],
            (comment_barrier_poll.stdout | default('[]') | from_json | list)
          )
      )
      | selectattr('body', 'defined')
      | selectattr('body', 'regex_search', '(' + (comment_barrier_patterns | join(')|(')) + ')')
      | list
    ) | length > 0

- name: "Comment barrier: prepare comments list"
  ansible.builtin.set_fact:
    comment_barrier_comments: >-
      {{ comment_barrier_poll.stdout | default('[]') | from_json | list }}

- name: "Comment barrier: reduce to latest comment when requested"
  ansible.builtin.set_fact:
    comment_barrier_comments: >-
      {{ comment_barrier_latest_only | ternary(comment_barrier_comments[-1:], comment_barrier_comments) }}

- name: "Comment barrier: collect matched comment"
  ansible.builtin.set_fact:
    comment_barrier_matched_comment: >-
      {{ (
           comment_barrier_comments
           | selectattr('body', 'defined')
           | selectattr('body', 'regex_search', '(' + (comment_barrier_patterns | join(')|(')) + ')')
           | list
         ) | first | default({}) }}

- name: "Comment barrier: expose outputs"
  ansible.builtin.set_fact:
    comment_barrier_matched: "{{ comment_barrier_matched_comment != {} }}"
    comment_barrier_matched_body: "{{ comment_barrier_matched_comment.body | default('') }}"
    comment_barrier_matched_author: "{{ comment_barrier_matched_comment.user.login | default('') }}"
    comment_barrier_matched_at: "{{ comment_barrier_matched_comment.created_at | default('') }}"
